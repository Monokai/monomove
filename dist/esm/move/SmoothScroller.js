import t from"../math/clamp.js";import i from"./RenderLoop.js";import e from"./Tween.js";let s=!1;try{const t=Object.defineProperty({},"passive",{get:()=>(s=!0,!0)});window.addEventListener("a",null,t),window.removeEventListener("a",null,t)}catch(t){}class o{isDown=!1;isLocked=!1;scroll=0;scrollHeight=0;#t=.01;#i=1;#e=0;#s=0;#o=0;#n=[];#l=null;#r=null;#h=null;#c=!1;#a=0;#d=0;#g=null;#u=null;#v=null;#w=null;#f=!0;#p=!1;#m=!1;#b=(new e).easing("0.35,0.15,0,1").onUpdate((t=>{window.scrollTo(0,t.y),this.#c=!0,this.scroll=t.y,this.#e=t.y,this.isDown=this.#e>=this.#s,this.#s=this.#e})).onStart((()=>{this.#m=!0})).onComplete((()=>{this.#m=!1}));#S=!!s&&{passive:!0};#x=null;#L=null;#O=null;#C=null;#A=null;#T=null;constructor(){let{container:e=window.document.body,content:s=window.document.body,scrollFactor:o=1,listener:n=window,debug:l=!1,onResize:r}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.#x=o,this.#L=e,this.#O=s,this.#C=n,this.#A=l,this.#T=r,this.#g=()=>{this.isLocked||(this.#p=!0)},this.#u=()=>{this.isLocked||(this.#c=!0,this.#e=t(this.getScrollPosition(),0,Math.round(this.scrollHeight-this.#o)))},this.#w=t=>{t.stopPropagation(),this.isLocked||(this.#p=!1)},this.#v=()=>{this.isLocked||(this.#b&&this.#b.stop(),this.#p=!1,this.#m=!1)},this.#C&&(this.#A,this.#C.addEventListener("touchstart",this.#g,this.#S),this.#C.addEventListener("scroll",this.#u,this.#S),this.#C.addEventListener("mousedown",this.#w,this.#S),this.#C.addEventListener("wheel",this.#v,this.#S)),this.#A&&(this.#r=window.document.createElement("canvas"),this.#L.appendChild(this.#r)),i.add(this,this.#I),i.play(),this.resize()}#I(){if(this.isLocked)return!0;if(this.scrollHeight=this.#O?this.#O.scrollHeight:0,this.scrollHeight!==this.#d)return this.resize(),this.scroll=this.#e,this.#F(this.scroll),this.#d=this.scrollHeight,!0;if(!this.#c)return!0;const t=(this.#e-this.scroll)*(this.#p?this.#i:this.#x);if(Math.abs(t)<this.#t&&(this.#p&&this.triggerAnimations(!0),this.#c=!1),this.scroll+=t,this.#f){this.#f=!1,this.scroll=this.#e,this.#A;const t=this.isDown;this.isDown=!0,this.triggerAnimations(!0),this.isDown=!1,this.triggerAnimations(!0),this.isDown=t}return null===this.#l&&(this.#l=this.#n),this.#F(this.scroll),!0}draw(){this.#F()}drawAll(){const t=this.#l;this.#l=this.#n,this.#F(),this.#l=t}getScrollPosition(){return void 0!==this.#C.scrollY?this.#C.scrollY:void 0!==this.#C.pageYOffset?this.#C.pageYOffset:void 0!==this.#C.scrollTop?this.#C.scrollTop:0}resize(){this.#L&&this.#O&&(this.scroll=this.#s=this.#e,this.scrollHeight=this.#O.scrollHeight,this.#o=window.innerHeight,this.#n.forEach((t=>{this.#y(t)})),this.#r&&(this.#r.width=window.innerWidth*window.devicePixelRatio,this.#r.height=window.innerHeight*window.devicePixelRatio,this.#r.style.position="fixed",this.#r.style.left=0,this.#r.style.top=0,this.#r.style.width=`${window.innerWidth}px`,this.#r.style.height=`${window.innerHeight}px`,this.#r.style.pointerEvents="none",this.#r.style.zIndex=9999999,this.#h=this.#r.getContext("2d")),this.#T&&this.#T(),this.#k())}triggerAnimations(){let i=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const e=window.devicePixelRatio;this.#h&&(this.#h.clearRect(0,0,this.#r.width,this.#r.height),this.#h.strokeStyle="#f00",this.#h.lineWidth=2*e,this.#h.beginPath()),(i?this.#n:this.#l).forEach((i=>{const s=i.box;if(!s||!s.width||!s.height)return;const o=i.animationObject;o.scroll=this.scroll;const n=i.directionOffset||0,l=i.offset||0,r=s.top+s.height-o.scroll+n*(this.isDown?-1:1)*this.#o+l*this.#o,h=r/(this.#o+s.height),c=(r-this.#o)/s.height;o.rawFactor=(1-h-.5)*i.speed+.5,o.rawBoxFactor=(1-c-.5)*i.speed+.5,o.factor=t(o.rawFactor,0,1),o.isInView=o.rawFactor>=0&&o.rawFactor<=1,o.boxFactor=t(o.rawBoxFactor,0,1),o.boxIsInView=o.rawBoxFactor>=0&&o.rawBoxFactor<=1,o.box=s,o.item=i.item,o.fixedTop&&(o.box.top=o.fixedTop),o.isInView!==o.previousIsInView&&(o.isInView?(o.isScrolledIn=!0,void 0===o.isScrolledInOnce&&(o.isScrolledInOnce=!0)):void 0!==o.previousIsInView&&(o.isScrolledOut=!0,void 0===o.isScrolledOutOnce&&(o.isScrolledOutOnce=!0))),i.animation&&i.previousFactor!==o.factor&&(i.animation(o),i.previousFactor=o.factor),o.isScrolledIn=!1,o.isScrolledOut=!1,!0===o.isScrolledInOnce&&(o.isScrolledInOnce=!1),!0===o.isScrolledOutOnce&&(o.isScrolledOutOnce=!1),o.previousIsInView=o.isInView,this.#h&&o.box.top+o.box.height-o.scroll>=0&&o.box.top-o.scroll<=this.#o&&this.#h.rect(o.box.left*e,o.box.top*e-o.scroll*e,o.box.width*e,o.box.height*e)})),this.#h&&this.#h.stroke()}#F(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.isDown=t>=this.#s,this.#l&&(this.triggerAnimations(),this.#s=t)}add(t,i){let e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=t&&t instanceof Array?t:[t];void 0===e.observeIn&&(e.observeIn=null),s.forEach((t=>{const s={centerOffset:0,originalTop:0,isVisible:!0};let o=null;window.IntersectionObserver&&void 0!==e.observeIn?(o=new window.IntersectionObserver((t=>{t.forEach((t=>{s.isVisible=t.isIntersecting,this.#k()}))}),{root:e.observeIn,rootMargin:`${e.directionOffset?100*e.directionOffset:e.speed?1/e.speed*100:0}% 0% ${e.directionOffset?100*e.directionOffset:e.offset?100*e.offset:e.speed?1/e.speed*100:0}% 0%`,threshold:0}),o.observe(t)):this.#l=null;const n={animation:i,directionOffset:e.directionOffset||0,offset:e.offset||0,speed:void 0===e.speed?1:e.speed,animationObject:s,item:t,observer:o};this.#y(n),this.#n.push(n)}))}#k(){this.#l=this.#n.filter((t=>t.animationObject.isVisible)),this.#A}remove(t){const i=t&&t instanceof Array?t:[t];this.#n=this.#n.filter((t=>i.indexOf(t.item)<0))}static getBox(t){let i=t,e=0,s=0;do{if(void 0===i.offsetLeft){const t=i.getBoundingClientRect(),o=window.document.documentElement;e+=t.left+window.pageXOffset-o.clientLeft,s+=t.top+window.pageYOffset-o.clientTop}else e+=i.offsetLeft,s+=i.offsetTop;i=i.offsetParent}while(i);if(void 0===t.offsetWidth){const i=t.getBoundingClientRect();return{left:e,top:s,width:i.width,height:i.height}}return{left:e,top:s,width:t.offsetWidth,height:t.offsetHeight}}#y(t){t.box=o.getBox(t.item),t.animationObject.centerOffset=.5*(this.#o-t.box.height),t.animationObject.originalTop=t.box.top,t.animationObject.scroll=t.animationObject.targetScroll=this.#e}scrollTo(){let i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.#b.from({y:this.scroll}).to({y:i},e??t(25e-5*Math.abs(i-this.scroll),.25,2.5)).start()}scrollToElement(t){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;const s=o.getBox(t);return this.scrollTo(s.top,i,e)}reset(){this.#n.length=0,this.#o=0}stop(){this.#c=!1}lock(){this.isLocked=!0}unlock(){this.isLocked=!1,window.scrollTo(0,this.scroll)}setContent(t){this.#O=t,this.resize()}unsetContent(){this.#O=null}setScrollFactor(t){this.#x=t}setTouchScrollFactor(t){this.#i=t}destroy(){this.#A&&this.#r.remove(),this.#C&&(this.#A,this.#C.removeEventListener("touchstart",this.#g,this.#S),this.#C.removeEventListener("wheel",this.#v,this.#S),this.#C.removeEventListener("mousedown",this.#w,this.#S),this.#C.removeEventListener("scroll",this.#u,this.#S)),this.reset(),this.stop()}}export{o as default};
