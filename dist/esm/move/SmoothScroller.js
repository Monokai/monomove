import t from"../math/clamp.js";import i from"./RenderLoop.js";import s from"./Tween.js";let e=!1;try{const t=Object.defineProperty({},"passive",{get:()=>(e=!0,!0)});window.addEventListener("a",null,t),window.removeEventListener("a",null,t)}catch(t){}class o{isDown=!1;isLocked=!1;scroll=0;scrollHeight=0;#t=1;#i=.01;#s=0;#e=0;#o=0;#n=[];#r=null;#l=null;#h=null;#c=!1;#a=0;#d=0;#u=0;#g=null;#v=null;#m=null;#w=null;#p=!0;#f=!1;#b=!1;#S=(new s).easing("0.35,0.15,0,1").onUpdate((t=>{window.scrollTo(0,t.y),this.#c=!0,this.scroll=t.y,this.#s=t.y,this.isDown=this.#s>=this.#e,this.#e=this.#s})).onStart((()=>{this.#b=!0})).onComplete((()=>{this.#b=!1}));#x=!!e&&{passive:!0};#T=null;#O=null;#A=null;#L=null;#C=null;#I=null;#F=null;#D=0;#k=0;#y=0;constructor({container:s=window.document.body,content:e=window.document.body,easing:o=(t=>Math.min(1,1.001-2**(-10*t))),scrollFactor:n=null,scrollDuration:r=0,listener:l=window,debug:h=!1,onResize:c}={}){if(this.#O=r,this.#A=s,this.#L=e,this.#C=l,this.#I=h,this.#y=o,this.#F=c,n)throw new Error("scrollFactor is deprecated, please use scrollDuration");this.#g=()=>{this.isLocked||(this.#f=!0)},this.#v=()=>{this.isLocked||(this.#c=!0,this.#s=t(this.getScrollPosition(),0,Math.round(this.scrollHeight-this.#o)),this.#k=this.scroll,this.#D=0)},this.#w=t=>{t.stopPropagation(),this.isLocked||(this.#f=!1)},this.#m=()=>{this.isLocked||(this.#S&&this.#S.stop(),this.#f=!1,this.#b=!1)},this.#C&&(this.#I,this.#C.addEventListener("touchstart",this.#g,this.#x),this.#C.addEventListener("scroll",this.#v,this.#x),this.#C.addEventListener("mousedown",this.#w,this.#x),this.#C.addEventListener("wheel",this.#m,this.#x)),this.#I&&(this.#l=window.document.createElement("canvas"),this.#A.appendChild(this.#l)),i.add(this,this.#E),i.play(),this.resize()}#E(i){if(this.isLocked)return!0;if(this.scrollWidth=this.#L?.scrollWidth??0,this.scrollHeight=this.#L?.scrollHeight??0,this.scrollWidth!==this.#d||this.scrollHeight!==this.#u)return this.resize(),this.scroll=this.#k=this.#s,this.#R(this.scroll),this.#d=this.scrollWidth,this.#u=this.scrollHeight,!0;if(!this.#c)return!0;Math.abs(this.#s-this.scroll)<this.#i&&(this.#I,this.#f&&(this.#I,this.triggerAnimations(!0)),this.#c=!1),this.#D+=i/1e3;const s=t(this.#D/(this.#f?this.#T:this.#O),0,1),e=this.#y(s);if(this.scroll=this.#k+(this.#s-this.#k)*e,this.#p){this.#p=!1,this.scroll=this.#k=this.#s,this.#I;const t=this.isDown;this.isDown=!0,this.triggerAnimations(!0),this.isDown=!1,this.triggerAnimations(!0),this.isDown=t}return null===this.#r&&(this.#r=this.#n),this.#R(this.scroll),!0}draw(){this.#R()}drawAll(){const t=this.#r;this.#r=this.#n,this.#R(),this.#r=t}getScrollPosition(){return void 0!==this.#C.scrollY?this.#C.scrollY:void 0!==this.#C.pageYOffset?this.#C.pageYOffset:void 0!==this.#C.scrollTop?this.#C.scrollTop:0}resize(){this.#A&&this.#L&&(this.scroll=this.#k=this.#e=this.#s,this.scrollHeight=this.#L.scrollHeight,this.#o=window.innerHeight,this.#t=window.devicePixelRatio,this.#n.forEach((t=>{this.#H(t)})),this.#l&&(this.#l.width=window.innerWidth*window.devicePixelRatio,this.#l.height=window.innerHeight*window.devicePixelRatio,this.#l.style.position="fixed",this.#l.style.left=0,this.#l.style.top=0,this.#l.style.width=`${window.innerWidth}px`,this.#l.style.height=`${window.innerHeight}px`,this.#l.style.pointerEvents="none",this.#l.style.zIndex=9999999,this.#h=this.#l.getContext("2d")),this.#F&&this.#F(),this.#j())}triggerAnimations(t=!1){this.#h&&(this.#h.clearRect(0,0,this.#l.width,this.#l.height),this.#h.strokeStyle="#f00",this.#h.lineWidth=2*this.#t,this.#h.beginPath());const i=t?this.#n:this.#r;i?.forEach((t=>{this.#B(t)})),this.#h&&this.#h.stroke()}#B(i,s){const e=i.box;if(!e||!e.width||!e.height)return;const o=i.animationObject;o.scroll=this.scroll;const n=i.directionOffset||0,r=i.offset||0,l=e.top+e.height-o.scroll+n*(this.isDown?-1:1)*this.#o+r*this.#o,h=l/(this.#o+e.height),c=(l-this.#o)/e.height;o.rawFactor=(1-h-.5)*i.speed+.5,o.rawBoxFactor=(1-c-.5)*i.speed+.5,o.factor=t(o.rawFactor,0,1),o.isInView=s??(o.rawFactor>=0&&o.rawFactor<=1),o.boxFactor=t(o.rawBoxFactor,0,1),o.boxIsInView=o.rawBoxFactor>=0&&o.rawBoxFactor<=1,o.box=e,o.item=i.item,o.index=i.index,o.fixedTop&&(o.box.top=o.fixedTop),o.isInView!==o.previousIsInView&&(o.isInView?(o.isScrolledIn=!0,void 0===o.isScrolledInOnce&&(o.isScrolledInOnce=!0)):void 0!==o.previousIsInView&&(o.isScrolledOut=!0,void 0===o.isScrolledOutOnce&&(o.isScrolledOutOnce=!0))),!i.animation||i.previousFactor===o.factor&&void 0===s||(i.animation(o),i.previousFactor=o.factor),o.isScrolledIn=!1,o.isScrolledOut=!1,!0===o.isScrolledInOnce&&(o.isScrolledInOnce=!1),!0===o.isScrolledOutOnce&&(o.isScrolledOutOnce=!1),o.previousIsInView=o.isInView,this.#h&&o.box.top+e.height-o.scroll>=0&&o.box.top-o.scroll<=this.#o&&this.#h.rect(o.box.left*this.#t,(o.box.top-o.scroll)*this.#t,o.box.width*this.#t,o.box.height*this.#t)}#R(t=0){this.isDown=t>=this.#e,this.#r&&(this.triggerAnimations(),this.#e=t)}add(t,i,s={}){const e=t&&t instanceof Array?t:[t];void 0===s.observeIn&&(s.observeIn=null),e.forEach(((t,e)=>{const o={animation:i,directionOffset:s.directionOffset||0,offset:s.offset||0,speed:void 0===s.speed?1:s.speed,animationObject:{centerOffset:0,originalTop:0,isVisible:!0},item:t,index:e};let n=null;window.IntersectionObserver&&void 0!==s.observeIn?(n=new window.IntersectionObserver((t=>{t.forEach((t=>{o.animationObject.isVisible=t.isIntersecting,this.#B(o,t.isIntersecting),this.#j()}))}),{root:s.observeIn,rootMargin:`${s.directionOffset?100*s.directionOffset:s.speed?1/s.speed*100:0}% 0% ${s.directionOffset?100*s.directionOffset:s.offset?100*s.offset:s.speed?1/s.speed*100:0}% 0%`,threshold:0}),n.observe(t)):this.#r=null,o.observer=n,this.#H(o),this.#n.push(o)}))}#j(){this.#r=this.#n.filter((t=>t.animationObject.isVisible)),this.#I}remove(t){const i=t&&t instanceof Array?t:[t];this.#n.forEach((t=>{i.indexOf(t.item)>=0&&(this.#B(t,!1),t.observer?.unobserve?.(t.item))})),this.#n=this.#n.filter((t=>i.indexOf(t.item)<0))}static getBox(t){let i=t,s=0,e=0;do{if(void 0===i.offsetLeft){const t=i.getBoundingClientRect(),o=window.document.documentElement;s+=t.left+window.pageXOffset-o.clientLeft,e+=t.top+window.pageYOffset-o.clientTop}else s+=i.offsetLeft,e+=i.offsetTop;i=i.offsetParent}while(i);if(void 0===t.offsetWidth){const i=t.getBoundingClientRect();return{left:s,top:e,width:i.width,height:i.height}}return{left:s,top:e,width:t.offsetWidth,height:t.offsetHeight}}#H(t){t.box=o.getBox(t.item),t.animationObject.centerOffset=.5*(this.#o-t.box.height),t.animationObject.originalTop=t.box.top,t.animationObject.scroll=t.animationObject.targetScroll=this.#s}scrollTo(i=0,s=null){return this.#S.from({y:this.scroll}).to({y:i},s??t(25e-5*Math.abs(i-this.scroll),.25,2.5)).start()}scrollToElement(t,i=0,s=null){const e=o.getBox(t);return this.scrollTo(e.top+i,s)}reset(){this.#n.length=0,this.#o=0}stop(){this.#c=!1}lock(){this.isLocked=!0}unlock(){this.isLocked=!1,window.scrollTo(0,this.scroll)}setContent(t){this.#L=t,this.resize()}unsetContent(){this.#L=null}setScrollDuration(t){this.#O=t}setTouchScrollDuration(t){this.#T=t}destroy(){this.#I&&this.#l.remove(),this.#C&&(this.#I,this.#C.removeEventListener("touchstart",this.#g,this.#x),this.#C.removeEventListener("wheel",this.#m,this.#x),this.#C.removeEventListener("mousedown",this.#w,this.#x),this.#C.removeEventListener("scroll",this.#v,this.#x)),this.#n.forEach((t=>{t.observer?.unobserve?.(t.item)})),this.reset(),this.stop()}}export{o as default};
