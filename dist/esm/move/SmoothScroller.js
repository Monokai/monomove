import t from"../math/clamp.js";import i from"../math/smoothValue.js";import s from"./RenderLoop.js";import e from"./Tween.js";let o=!1;try{const t=Object.defineProperty({},"passive",{get:()=>(o=!0,!0)});window.addEventListener("a",null,t),window.removeEventListener("a",null,t)}catch(t){}class n{isDown=!1;isLocked=!1;scroll=0;scrollHeight=0;#t=1;#i=.01;#s=0;#e=0;#o=0;#n=[];#l=null;#r=null;#h=null;#c=null;#a=!1;#d=0;#u=0;#g=0;#m=null;#v=null;#w=null;#p=null;#f=!0;#b=!1;#S=!1;#x=(new e).easing("0.35,0.15,0,1").onUpdate((t=>{window.scrollTo(0,t.y),this.#a=!0,this.scroll=t.y,this.#s=t.y,this.isDown=this.#s>=this.#e,this.#e=this.#s})).onStart((()=>{this.#S=!0})).onComplete((()=>{this.#S=!1}));#T=!!o&&{passive:!0};#A=null;#O=null;#L=null;#C=null;#I=null;#F=null;#D=null;#k=0;#E=0;#y=0;constructor({container:i=window.document.body,content:e=window.document.body,easing:o=(t=>Math.min(1,1.001-2**(-10*t))),scrollFactor:n=null,scrollDuration:l=0,listener:r=window,debug:h=!1,onResize:c}={}){if(this.#O=l,this.#L=i,this.#C=e,this.#I=r,this.#F=h,this.#y=o,this.#D=c,n)throw new Error("scrollFactor is deprecated, please use scrollDuration");this.#m=()=>{this.isLocked||(this.#b=!0)},this.#v=()=>{this.isLocked||(this.#a=!0,this.#s=t(this.getScrollPosition(),0,Math.round(this.scrollHeight-this.#o)),this.#E=this.scroll,this.#k=0)},this.#p=t=>{t.stopPropagation(),this.isLocked||(this.#b=!1)},this.#w=()=>{this.isLocked||(this.#x&&this.#x.stop(),this.#b=!1,this.#S=!1)},this.#I&&(this.#F,this.#I.addEventListener("touchstart",this.#m,this.#T),this.#I.addEventListener("scroll",this.#v,this.#T),this.#I.addEventListener("mousedown",this.#p,this.#T),this.#I.addEventListener("wheel",this.#w,this.#T)),this.#F&&(this.#h=window.document.createElement("canvas"),this.#L.appendChild(this.#h)),s.add(this,this.#R),s.play(),this.resize()}#R(i){if(this.isLocked)return!0;if(this.scrollWidth=this.#C?.scrollWidth??0,this.scrollHeight=this.#C?.scrollHeight??0,this.scrollWidth!==this.#u||this.scrollHeight!==this.#g)return this.resize(),this.scroll=this.#E=this.#s,this.#V(this.scroll),this.#u=this.scrollWidth,this.#g=this.scrollHeight,!0;if(this.#r?.forEach((t=>{Math.abs(t.animationObject.smoothScrollValue-this.scroll)>this.#i&&this.#j(t,!0,i)})),!this.#a)return!0;Math.abs(this.#s-this.scroll)<this.#i&&(this.#F,this.#b&&(this.#F,this.triggerAnimations(!0)),this.#a=!1),this.#k+=i/1e3;const s=t(this.#k/(this.#b?this.#A:this.#O),0,1),e=this.#y(s);if(this.scroll=this.#E+(this.#s-this.#E)*e,this.#f){this.#f=!1,this.scroll=this.#E=this.#s,this.#F;const t=this.isDown;this.isDown=!0,this.triggerAnimations(!0),this.isDown=!1,this.triggerAnimations(!0),this.isDown=t}return null===this.#l&&(this.#l=this.#n),this.#V(this.scroll),!0}draw(){this.#V()}drawAll(){const t=this.#l;this.#l=this.#n,this.#V(),this.#l=t}getScrollPosition(){return void 0!==this.#I.scrollY?this.#I.scrollY:void 0!==this.#I.pageYOffset?this.#I.pageYOffset:void 0!==this.#I.scrollTop?this.#I.scrollTop:0}resize(){this.#L&&this.#C&&(this.scroll=this.#E=this.#e=this.#s,this.scrollHeight=this.#C.scrollHeight,this.#o=window.innerHeight,this.#t=window.devicePixelRatio,this.#n.forEach((t=>{this.#H(t)})),this.#h&&(this.#h.width=window.innerWidth*window.devicePixelRatio,this.#h.height=window.innerHeight*window.devicePixelRatio,this.#h.style.position="fixed",this.#h.style.left=0,this.#h.style.top=0,this.#h.style.width=`${window.innerWidth}px`,this.#h.style.height=`${window.innerHeight}px`,this.#h.style.pointerEvents="none",this.#h.style.zIndex=9999999,this.#c=this.#h.getContext("2d")),this.#D&&this.#D(),this.#B())}triggerAnimations(t=!1){this.#c&&(this.#c.clearRect(0,0,this.#h.width,this.#h.height),this.#c.strokeStyle="#f00",this.#c.lineWidth=2*this.#t,this.#c.beginPath());const i=t?this.#n:this.#l;i?.forEach((t=>{this.#j(t)})),this.#c&&this.#c.stroke()}#j(s,e,o){const n=s.box;if(!n||!n.width||!n.height)return;const l=s.animationObject;if(l.scroll=this.scroll,s.smoothing&&s.smoothScroll){const t=60*(o||0)/1e3;l.smoothScrollValue=s.smoothScroll(l.scroll,t,s.smoothing)}else l.smoothScrollValue=l.scroll;const r=s.directionOffset||0,h=s.offset||0,c=n.top+n.height-l.smoothScrollValue+r*(this.isDown?-1:1)*this.#o+h*this.#o,a=c/(this.#o+n.height),d=(c-this.#o)/n.height;l.rawFactor=(1-a-.5)*s.speed+.5,l.rawBoxFactor=(1-d-.5)*s.speed+.5,l.factor=t(l.rawFactor,0,1),l.isInView=e??(l.rawFactor>=0&&l.rawFactor<=1),l.boxFactor=t(l.rawBoxFactor,0,1),l.boxIsInView=l.rawBoxFactor>=0&&l.rawBoxFactor<=1,l.box=n,l.item=s.item,l.index=s.index,l.fixedTop&&(l.box.top=l.fixedTop),l.isInView!==l.previousIsInView&&(l.isInView?(s.smoothing&&(s.smoothScroll=i(l.scroll)),l.isScrolledIn=!0,void 0===l.isScrolledInOnce&&(l.isScrolledInOnce=!0)):void 0!==l.previousIsInView&&(l.isScrolledOut=!0,s.smoothScroll=null,void 0===l.isScrolledOutOnce&&(l.isScrolledOutOnce=!0))),!s.animation||s.previousFactor===l.factor&&void 0===e||(s.animation(l),s.previousFactor=l.factor),l.isScrolledIn=!1,l.isScrolledOut=!1,!0===l.isScrolledInOnce&&(l.isScrolledInOnce=!1),!0===l.isScrolledOutOnce&&(l.isScrolledOutOnce=!1),l.previousIsInView=l.isInView,this.#c&&l.box.top+n.height-l.scroll>=0&&l.box.top-l.scroll<=this.#o&&this.#c.rect(l.box.left*this.#t,(l.box.top-l.scroll)*this.#t,l.box.width*this.#t,l.box.height*this.#t)}#V(t=0){this.isDown=t>=this.#e,this.#l&&(this.triggerAnimations(),this.#e=t)}add(t,i,s={}){const e=t&&t instanceof Array?t:[t];void 0===s.observeIn&&(s.observeIn=null),e.forEach(((t,e)=>{const o={animation:i,directionOffset:s.directionOffset||0,offset:s.offset||0,speed:void 0===s.speed?1:s.speed,smoothing:s.smoothing,animationObject:{centerOffset:0,originalTop:0,isVisible:!0,data:s.data},item:t,index:e};let n=null;window.IntersectionObserver&&void 0!==s.observeIn?(n=new window.IntersectionObserver((t=>{t.forEach((t=>{o.animationObject.isVisible=t.isIntersecting,this.#j(o,t.isIntersecting),this.#B()}))}),{root:s.observeIn,rootMargin:`${s.directionOffset?100*s.directionOffset:s.speed?1/s.speed*100:0}% 0% ${s.directionOffset?100*s.directionOffset:s.offset?100*s.offset:s.speed?1/s.speed*100:0}% 0%`,threshold:0}),n.observe(t)):this.#l=null,o.observer=n,this.#H(o),this.#n.push(o)}))}#B(){const t=t=>t.smoothing;this.#l=this.#n.filter((i=>i.animationObject.isVisible&&!t(i))),this.#r=this.#n.filter((i=>i.animationObject.isVisible&&t(i))),this.#F}remove(t){const i=t&&t instanceof Array?t:[t];this.#n.forEach((t=>{i.indexOf(t.item)>=0&&(this.#j(t,!1),t.observer?.unobserve?.(t.item))})),this.#n=this.#n.filter((t=>i.indexOf(t.item)<0))}static getBox(t){let i=t,s=0,e=0;do{if(void 0===i.offsetLeft){const t=i.getBoundingClientRect(),o=window.document.documentElement;s+=t.left+window.pageXOffset-o.clientLeft,e+=t.top+window.pageYOffset-o.clientTop}else s+=i.offsetLeft,e+=i.offsetTop;i=i.offsetParent}while(i);if(void 0===t.offsetWidth){const i=t.getBoundingClientRect();return{left:s,top:e,width:i.width,height:i.height}}return{left:s,top:e,width:t.offsetWidth,height:t.offsetHeight}}#H(t){t.box=n.getBox(t.item),t.animationObject.centerOffset=.5*(this.#o-t.box.height),t.animationObject.originalTop=t.box.top,t.animationObject.scroll=t.animationObject.targetScroll=this.#s}scrollTo(i=0,s=null){return this.#x.from({y:this.scroll}).to({y:i},s??t(25e-5*Math.abs(i-this.scroll),.25,2.5)).start()}scrollToElement(t,i=0,s=null){const e=n.getBox(t);return this.scrollTo(e.top+i,s)}reset(){this.#n.length=0,this.#o=0}stop(){this.#a=!1}lock(){this.isLocked=!0}unlock(){this.isLocked=!1,window.scrollTo(0,this.scroll)}setContent(t){this.#C=t,this.resize()}unsetContent(){this.#C=null}setScrollDuration(t){this.#O=t}setTouchScrollDuration(t){this.#A=t}destroy(){this.#F&&this.#h.remove(),this.#I&&(this.#F,this.#I.removeEventListener("touchstart",this.#m,this.#T),this.#I.removeEventListener("wheel",this.#w,this.#T),this.#I.removeEventListener("mousedown",this.#p,this.#T),this.#I.removeEventListener("scroll",this.#v,this.#T)),this.#n.forEach((t=>{t.observer?.unobserve?.(t.item)})),this.reset(),this.stop()}}export{n as default};
